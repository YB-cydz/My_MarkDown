## 卡尔曼滤波(线性的KF->非线性的EKF)

> **==说在前面：在原先KF的基础上，为方便对比，直接在EKF需要改动公式的地方添加新公式==**
>
> **$\hat{\mathbf{x}}_{n,n}$表示当前状态的估计值**
>
> **$\hat{\mathbf{x}}_{n,n-1}$表示n-1时刻对n时刻的预测值**

### 辅助方程

---

#### 测量方程

$$
\mathbf{z}_n=\mathbf{H}\mathbf{x}_n+\mathbf{v}_n\quad->\quad\mathbf{z}_n=\mathbf{h}(\mathbf{x}_n)+\mathbf{v}_n
$$



其中：

|    $\mathbf{z}_n$    |                          是测量向量                          |
| :------------------: | :----------------------------------------------------------: |
|    $\mathbf{x}_n$    |                 是真实系统状态量（隐藏状态）                 |
|    $\mathbf{v}_n$    |                  是随机噪声向量（测量噪声）                  |
|     $\mathbf{H}$     | 是 **观测矩阵**，用于测量到的数据（**测量值**）与我们想要的数据（**系统状态**）之间的转换（比如声波测距时将时间转换成距离） |
| (EKF)$\mathbf{h}(⋅)$ | 非线性观测函数，作用类似于原先的$\mathbf{H}\mathbf{x}_n$，只不过$\mathbf{z}_n$到$\mathbf{x}_n$之间的变换不再是线性的 |

---

#### 测量不确定性

测量协方差为：
$$
\mathbf{R}_n=\mathbf{E}(\mathbf{v}_n\mathbf{v}_n^T)
$$
其中：

| $\mathbf{R}_n$ | 是测量的协方差矩阵 |
| :------------: | :----------------: |
| $\mathbf{v}_n$ |     是测量误差     |

---

#### 过程噪声不确定性

过程噪声协方差为：
$$
\mathbf{Q}_n=\mathbf{E}(\boldsymbol{\omega}_n\boldsymbol{\omega}_n^T)
$$
式中：

|     $\mathbf{Q}_n$      | 是过程噪声协方差矩阵 |
| :---------------------: | :------------------: |
| $\boldsymbol{\omega}_n$ |      是过程噪声      |

---

#### 估计不确定性

估计协方差为：
$$
\mathbf{P}_{n,n}=\mathbf{E}(\mathbf{e}_n\mathbf{e}_n^T)=\mathbf{E}((\mathbf{x}_n-\hat{\mathbf{x}}_{n,n})(\mathbf{x}_n-\hat{\mathbf{x}}_{n,n})^T)
$$
式中：

|    $\mathbf{P}_{n,n}$    |  是当前估计值的协方差矩阵  |
| :----------------------: | :------------------------: |
|      $\mathbf{e}_n$      |         是估计误差         |
|      $\mathbf{x}_n$      | 是真实系统状态（隐藏状态） |
| $\hat{\mathbf{x}}_{n,n}$ |  是 n 时刻的系统状态估计   |

---

### 状态更新阶段（由先验值融合测量值，使得估计值更平滑，而且接近真值）

---

#### 			卡尔曼增益方程

$$
\mathbf{K}_n=\mathbf{P}_{n,n-1}\mathbf{H}^T(\mathbf{H}\mathbf{P}_{n,n-1}\mathbf{H}^T+\mathbf{R}_n)\quad->\quad\mathbf{K}_n=\mathbf{P}_{n,n-1}\mathbf{H}_n^T(\mathbf{H}_n\mathbf{P}_{n,n-1}\mathbf{H}_n^T+\mathbf{R}_n)
$$

式中：
| $\mathbf{K}_n$|是卡尔曼增益|
|:-:|:---:|
|$\mathbf{P}_{n,n-1}$|是前一时刻对当前状态的预测的协方差矩阵|
|$\mathbf{H}$|是观测矩阵|
|$\mathbf{R}_n$|是测量噪声的协方差矩阵|
|(EKF)  $\mathbf{H}_n$|$\mathbf{H}_n=\frac{\partial\mathbf{h}}{\partial\mathbf{x}}\big|_{\hat{\mathbf{x}}_{n,n-1}}$，观测函数的一阶[雅各比矩阵](##雅各比矩阵)|

---

#### 			状态更新方程

$$
\hat{\mathbf{x}}_{n,n}=\hat{\mathbf{x}}_{n,n-1}+\mathbf{K}_n(\mathbf{z}_n-\mathbf{H}\hat{\mathbf{x}}_{n,n-1})\quad->\quad\hat{\mathbf{x}}_{n,n}=\hat{\mathbf{x}}_{n,n-1}+\mathbf{K}_n(\mathbf{z}_n-\mathbf{h}(\hat{\mathbf{x}}_{n,n-1}))
$$

式中：

|  $\hat{\mathbf{x}}_{n,n}$  | 是 $n$ 时刻的系统状态估计              |
| :------------------------: | :---:|
| $\hat{\mathbf{x}}_{n,n-1}$ | 是 $n−1$ 时刻对 $n$ 时刻系统状态的预测 |
|       $\mathbf{K}_n$       | 是卡尔曼增益                           |
|       $\mathbf{z}_n$       | 是测量值                               |
|        $\mathbf{H}$        | 是观测矩阵                             |
| (EKF)$\mathbf{h}(⋅)$ | 非线性观测函数，作用类似于原先的$\mathbf{H}\mathbf{x}_n$，只不过$\mathbf{z}_n$到$\mathbf{x}_n$之间的变换不再是线性的 |

#### 				协方差更新方程
---

$$
\mathbf{P}_{n,n}=(\mathbf{I}-\mathbf{K}_n\mathbf{H})\mathbf{P}_{n,n-1}(\mathbf{I}-\mathbf{K}_n\mathbf{H})^T+\mathbf{K}_n\mathbf{R}_n\mathbf{K}_n^T\quad->\quad\mathbf{P}_{n,n}=(\mathbf{I}-\mathbf{K}_n\mathbf{H}_n)\mathbf{P}_{n,n-1}
$$

式中：

|  $\mathbf{P}_{n,n}$   |                  是当前状态估计的协方差矩阵                  |
| :-------------------: | :----------------------------------------------------------: |
| $\mathbf{P}_{n,n-1}$  |            是前一时刻对当前状态的预测的协方差矩阵            |
|    $\mathbf{K}_n$     |                         是卡尔曼增益                         |
|     $\mathbf{H}$      |                          是观测矩阵                          |
|    $\mathbf{R}_n$     |                    是测量噪声的协方差矩阵                    |
|     $\mathbf{I}$      | 是单位阵（一个 n×n 且仅有对角元素为1、其余元素均为0的方阵）  |
| (EKF)  $\mathbf{H}_n$ | $\mathbf{H}_n=\frac{\partial\mathbf{h}}{\partial\mathbf{x}}\big|_{\hat{\mathbf{x}}_{n,n-1}}$，观测函数的一阶[雅各比矩阵](##雅各比矩阵) |

---

### 		状态检测阶段

---

#### 				状态外插方程（根据某种规律，如物理的动态方程等，根据当前状态预测下一个状态）

$$
\hat{\mathbf{x}}_{n+1,n}=\mathbf{F}\hat{\mathbf{x}}_{n,n}+\mathbf{G}\mathbf{u}_n+\boldsymbol{\omega}_n\quad->\quad\hat{\mathbf{x}}_{n+1,n}=\mathbf{f}(\hat{\mathbf{x}}_{n,n},\mathbf{u}_n)+\boldsymbol{\omega}_n
$$

式中：

| $\hat{\mathbf{x}}_{n+1,n}$ |              是 n 时刻对 n+1 时刻系统状态的预测              |
| :------------------------: | :----------------------------------------------------------: |
|  $\hat{\mathbf{x}}_{n,n}$  |                 是 n 时刻系统状态向量的估计                  |
|       $\mathbf{u}_n$       | 是 **控制向量** 或 **输入向量** - 该系统的一个 可测量的（确定性的）输入 |
|  $\boldsymbol{\omega}_n$   | 是 **过程噪声** 或 扰动 - 能够影响系统状态的 不可测量的 输入 |
|        $\mathbf{F}$        |                     是 **状态转移矩阵**                      |
|        $\mathbf{G}$        | 是 **控制矩阵** 或 **输入转移矩阵** （将控制量映射到状态变量上） |
|    (EKF)$\mathbf{f}(⋅)$    | 非线性转移函数，作用类似于原先的$\mathbf{F}\hat{\mathbf{x}}_{n,n}+\mathbf{G}\mathbf{u}_n$，只不过满足的函数关系不再是线性的 |

---

#### 				协方差外插方程（状态的方差，与状态外插方程满足以下数学关系：任何服从方差为 $ σ^2 $ 的正态分布的随机变量$ x$，$kx$ 服从方差为 $k^2σ^2$ 的正态分布）

$$
\mathbf{P}_{n+1,n}=\mathbf{F}\mathbf{P}_{n,n}\mathbf{F^T}+\mathbf{Q}_n\quad->\quad\mathbf{P}_{n+1,n}=\mathbf{F}_n\mathbf{P}_{n,n}\mathbf{F}_n^T+\mathbf{Q}_n
$$

其中：

|  $\mathbf{P}_{n,n}$  | 是当前状态估计的不确定性的平方（协方差矩阵）     |
| :------------------: |:---: |
| $\mathbf{P}_{n+1,n}$ | 是下一个状态预测的不确定性的平方（协方差矩阵）   |
|     $\mathbf{F}$     | 状态转移矩阵，与状态外插方程中的$\mathbf{F}$相同 |
|     $\mathbf{Q}_n$     | 是过程噪声矩阵                                   |
| (EKF)$\mathbf{F}_n$ | $\mathbf{F}_n=\frac{\partial\mathbf{f}}{\partial\mathbf{x}}\big|_{\hat{\mathbf{x}}_{n,n},\mathbf{u}_n}$，转移函数的一阶[雅各比矩阵](##雅各比矩阵) |

## 雅各比矩阵

$$
J = 
\frac{\partial(f_1, f_2, \dots, f_m)}{\partial(x_1, x_2, \dots, x_n)}
=
\begin{bmatrix}
\frac{\partial f_1}{\partial x_1} & \frac{\partial f_1}{\partial x_2} & \cdots & \frac{\partial f_1}{\partial x_n} \\
\frac{\partial f_2}{\partial x_1} & \frac{\partial f_2}{\partial x_2} & \cdots & \frac{\partial f_2}{\partial x_n} \\
\vdots & \vdots & \ddots & \vdots \\
\frac{\partial f_m}{\partial x_1} & \frac{\partial f_m}{\partial x_2} & \cdots & \frac{\partial f_m}{\partial x_n}
\end{bmatrix}
$$
